<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bella Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>

    <script>
        const API_BASE = 'http://localhost:3001';
        let authToken = localStorage.getItem('bella_admin_token') || '';
        let config = {};

        // DOM Elements
        const app = document.getElementById('app');

        // Check if logged in
        function isLoggedIn() {
            return authToken && authToken.length > 0;
        }

        // Render Login Page
        function renderLogin() {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Bella Admin Panel</h1>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded mb-4"></div>
                        <form id="loginForm">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-semibold mb-2">Password</label>
                                <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Enter admin password">
                            </div>
                            <button type="submit" class="w-full bg-amber-600 text-white py-3 rounded-lg font-semibold hover:bg-amber-700 transition">
                                Login
                            </button>
                        </form>
                        <p class="mt-4 text-center text-gray-500 text-sm">Default password: bella2024</p>
                    </div>
                </div>
            `;

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        // Handle Login
        async function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const res = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await res.json();
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('bella_admin_token', authToken);
                    loadDashboard();
                } else {
                    errorDiv.textContent = 'Invalid password';
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) {
                errorDiv.textContent = 'Connection error. Is the server running?';
                errorDiv.classList.remove('hidden');
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/config`);
                config = await res.json();
                renderDashboard();
            } catch (err) {
                app.innerHTML = `<div class="p-8 text-red-600">Error loading config. Is the server running?</div>`;
            }
        }

        // Render Dashboard
        function renderDashboard() {
            app.innerHTML = `
                <nav class="bg-gray-900 text-white p-4">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <h1 class="text-xl font-bold">Bella Admin</h1>
                        <div class="flex items-center gap-4">
                            <a href="index.html" target="_blank" class="text-gray-300 hover:text-white text-sm">View Site</a>
                            <button onclick="logout()" class="bg-red-600 px-4 py-2 rounded text-sm hover:bg-red-700">Logout</button>
                        </div>
                    </div>
                </nav>

                <div class="max-w-7xl mx-auto p-6">
                    <div class="mb-6">
                        <p class="text-gray-500 text-sm">Last updated: ${new Date(config.lastUpdated).toLocaleString()}</p>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b mb-6">
                        <button onclick="showTab('categories')" class="tab-btn px-6 py-3 font-semibold text-gray-600 border-b-2 border-transparent hover:text-amber-600" data-tab="categories">Category Images</button>
                        <button onclick="showTab('banners')" class="tab-btn px-6 py-3 font-semibold text-gray-600 border-b-2 border-transparent hover:text-amber-600" data-tab="banners">Banners</button>
                        <button onclick="showTab('company')" class="tab-btn px-6 py-3 font-semibold text-gray-600 border-b-2 border-transparent hover:text-amber-600" data-tab="company">Company Info</button>
                        <button onclick="showTab('seo')" class="tab-btn px-6 py-3 font-semibold text-gray-600 border-b-2 border-transparent hover:text-amber-600" data-tab="seo">SEO</button>
                    </div>

                    <!-- Tab Content -->
                    <div id="tabContent"></div>
                </div>

                <!-- Status Message -->
                <div id="statusMsg" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hidden"></div>
            `;

            showTab('categories');
        }

        // Show Tab
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('border-amber-600', 'text-amber-600');
                    btn.classList.remove('border-transparent');
                } else {
                    btn.classList.remove('border-amber-600', 'text-amber-600');
                    btn.classList.add('border-transparent');
                }
            });

            const content = document.getElementById('tabContent');

            switch(tabName) {
                case 'categories':
                    content.innerHTML = renderCategoryImages();
                    break;
                case 'banners':
                    content.innerHTML = renderBanners();
                    break;
                case 'company':
                    content.innerHTML = renderCompanyInfo();
                    break;
                case 'seo':
                    content.innerHTML = renderSEO();
                    break;
            }
        }

        // Render Category Images
        function renderCategoryImages() {
            const categories = config.categoryImages || {};
            return `
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold mb-4">Category Images</h2>
                    <p class="text-gray-500 mb-6">Upload custom images for each category. These override the default placeholders.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${Object.entries(categories).map(([key, value]) => `
                            <div class="border rounded-lg p-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2 capitalize">${key}</label>
                                <div class="aspect-video bg-gray-100 rounded mb-3 overflow-hidden">
                                    ${value ? `<img src="${API_BASE}${value}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">` : '<div class="flex items-center justify-center h-full text-gray-400">No image</div>'}
                                </div>
                                <input type="text" value="${value || ''}" class="w-full px-3 py-2 border rounded text-sm mb-2" placeholder="Image path" onchange="updateCategoryImage('${key}', this.value)">
                                <input type="file" accept="image/*" class="text-sm" onchange="uploadCategoryImage('${key}', this)">
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-6 pt-4 border-t">
                        <h3 class="font-semibold mb-3">Add New Category</h3>
                        <div class="flex gap-3">
                            <input type="text" id="newCatName" class="px-3 py-2 border rounded" placeholder="Category name (lowercase)">
                            <button onclick="addCategory()" class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700">Add</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Banners
        function renderBanners() {
            const banners = config.banners || {};
            return `
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold mb-4">Banners</h2>

                    <div class="space-y-6">
                        <!-- Hero Banner -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-semibold mb-3">Hero Banner</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Desktop Image</label>
                                    <input type="text" value="${banners.hero?.image || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateBanner('hero', 'image', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Mobile Image</label>
                                    <input type="text" value="${banners.hero?.mobileImage || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateBanner('hero', 'mobileImage', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Title Override</label>
                                    <input type="text" value="${banners.hero?.title || ''}" class="w-full px-3 py-2 border rounded text-sm" placeholder="Leave empty for default" onchange="updateBanner('hero', 'title', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Subtitle Override</label>
                                    <input type="text" value="${banners.hero?.subtitle || ''}" class="w-full px-3 py-2 border rounded text-sm" placeholder="Leave empty for default" onchange="updateBanner('hero', 'subtitle', this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- Promo Banner -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-semibold mb-3">Promotional Banner</h3>
                            <div class="flex items-center gap-3 mb-4">
                                <input type="checkbox" id="promoEnabled" ${banners.promo?.enabled ? 'checked' : ''} onchange="updateBanner('promo', 'enabled', this.checked)">
                                <label for="promoEnabled">Enable promotional banner</label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Image</label>
                                    <input type="text" value="${banners.promo?.image || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateBanner('promo', 'image', this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Link</label>
                                    <input type="text" value="${banners.promo?.link || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateBanner('promo', 'link', this.value)">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm text-gray-600 mb-1">Text</label>
                                    <input type="text" value="${banners.promo?.text || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateBanner('promo', 'text', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveConfig()" class="mt-6 bg-amber-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-amber-700">Save Changes</button>
                </div>
            `;
        }

        // Render Company Info
        function renderCompanyInfo() {
            const info = config.companyInfo || {};
            const social = info.socialLinks || {};
            return `
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold mb-4">Company Information</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone</label>
                            <input type="text" value="${info.phone || ''}" class="w-full px-3 py-2 border rounded" onchange="updateCompanyInfo('phone', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" value="${info.email || ''}" class="w-full px-3 py-2 border rounded" onchange="updateCompanyInfo('email', this.value)">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Address</label>
                            <input type="text" value="${info.address || ''}" class="w-full px-3 py-2 border rounded" onchange="updateCompanyInfo('address', this.value)">
                        </div>
                    </div>

                    <h3 class="font-semibold mt-6 mb-4">Social Links</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Facebook</label>
                            <input type="url" value="${social.facebook || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateSocialLink('facebook', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Instagram</label>
                            <input type="url" value="${social.instagram || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateSocialLink('instagram', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Twitter</label>
                            <input type="url" value="${social.twitter || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateSocialLink('twitter', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">LinkedIn</label>
                            <input type="url" value="${social.linkedin || ''}" class="w-full px-3 py-2 border rounded text-sm" onchange="updateSocialLink('linkedin', this.value)">
                        </div>
                    </div>

                    <button onclick="saveConfig()" class="mt-6 bg-amber-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-amber-700">Save Changes</button>
                </div>
            `;
        }

        // Render SEO
        function renderSEO() {
            const seo = config.seo || {};
            return `
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold mb-4">SEO Settings</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Page Title</label>
                            <input type="text" value="${seo.title || ''}" class="w-full px-3 py-2 border rounded" onchange="updateSEO('title', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Meta Description</label>
                            <textarea class="w-full px-3 py-2 border rounded" rows="3" onchange="updateSEO('description', this.value)">${seo.description || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Keywords (comma-separated)</label>
                            <input type="text" value="${seo.keywords || ''}" class="w-full px-3 py-2 border rounded" onchange="updateSEO('keywords', this.value)">
                        </div>
                    </div>

                    <button onclick="saveConfig()" class="mt-6 bg-amber-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-amber-700">Save Changes</button>
                </div>
            `;
        }

        // Update functions
        function updateCategoryImage(key, value) {
            config.categoryImages[key] = value;
        }

        function updateBanner(banner, field, value) {
            if (!config.banners[banner]) config.banners[banner] = {};
            config.banners[banner][field] = value;
        }

        function updateCompanyInfo(field, value) {
            config.companyInfo[field] = value;
        }

        function updateSocialLink(platform, value) {
            if (!config.companyInfo.socialLinks) config.companyInfo.socialLinks = {};
            config.companyInfo.socialLinks[platform] = value;
        }

        function updateSEO(field, value) {
            config.seo[field] = value;
        }

        function addCategory() {
            const name = document.getElementById('newCatName').value.toLowerCase().trim();
            if (name && !config.categoryImages[name]) {
                config.categoryImages[name] = '';
                showTab('categories');
            }
        }

        // Upload image
        async function uploadCategoryImage(category, input) {
            if (!input.files[0]) return;

            const formData = new FormData();
            formData.append('image', input.files[0]);
            formData.append('folder', 'categories');

            try {
                const res = await fetch(`${API_BASE}/api/admin/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const data = await res.json();
                if (data.success) {
                    config.categoryImages[category] = data.path;
                    await saveConfig();
                    showTab('categories');
                    showStatus('Image uploaded successfully!');
                }
            } catch (err) {
                showStatus('Upload failed', true);
            }
        }

        // Save config
        async function saveConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(config)
                });

                const data = await res.json();
                if (data.success) {
                    config = data.config;
                    showStatus('Changes saved!');
                }
            } catch (err) {
                showStatus('Failed to save', true);
            }
        }

        // Show status message
        function showStatus(msg, isError = false) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-green-600'} text-white`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        // Logout
        function logout() {
            authToken = '';
            localStorage.removeItem('bella_admin_token');
            renderLogin();
        }

        // Initialize
        if (isLoggedIn()) {
            loadDashboard();
        } else {
            renderLogin();
        }
    </script>
</body>
</html>
